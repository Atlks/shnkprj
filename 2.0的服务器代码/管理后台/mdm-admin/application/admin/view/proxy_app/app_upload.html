<script src="__CDN__/assets/alioss/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
<form id="upload-form" class="form-horizontal" role="form" data-toggle="validator" method="POST" action="">
    <div class="form-group">
        <label class="control-label col-xs-12 col-sm-2">{:__('Name')}:</label>
        <div class="col-xs-12 col-sm-8">
            <input id="c-name" data-rule="required" class="form-control" name="row[name]" type="text" value="{$app.name}">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-xs-12 col-sm-2">{:__('Path')}:</label>
        <div class="col-xs-12 col-sm-8">
            <input id="c-path" data-rule="required" class="form-control" name="row[path]" type="text" value="">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-xs-12 col-sm-2"></label>
        <div class="col-xs-12 col-sm-8" id="ossfile">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-xs-12 col-sm-2"></label>
        <div class="col-xs-12 col-sm-8">
            <label class="control-label col-xs-12 col-sm-2"></label>
            <div class="col-xs-12 col-sm-8">
                <div class="col-xs-4 col-sm-6">
                    <button type="button" id="choose" class="btn btn-success">选择文件</button>
                </div>
                <div class="col-xs-6 col-sm-6">
                    <button type="button" id="postfiles" class="btn btn-success">上传</button>
                </div>
            </div>
        </div>
    </div>
    <div class="form-group layer-footer">
        <label class="control-label col-xs-12 col-sm-2"></label>
        <div class="col-xs-12 col-sm-8">
            <button type="submit" class="btn btn-success btn-embossed disabled">{:__('OK')}</button>
            <button type="reset" class="btn btn-default btn-embossed">{:__('Reset')}</button>
        </div>
    </div>
</form>
<script>
    var cache_path="";
    var rand_string=random_string(10);
    var uploader = new plupload.Uploader({
        runtimes : 'html5,flash,silverlight,html4',
        browse_button : 'choose',
        multi_selection: false,
        container: document.getElementById('upload-form'),
        flash_swf_url : 'lib/plupload-2.1.2/js/Moxie.swf',
        silverlight_xap_url : 'lib/plupload-2.1.2/js/Moxie.xap',
        url : 'https://oss.aliyuncs.com',
        filters: {
            mime_types : [
                { title : "IPA包", extensions : "ipa" }
            ],
            max_file_size : '2000mb', //最大只能上传10mb的文件
            prevent_duplicates : true //不允许选取重复文件
        },

        init: {
            PostInit: function() {
                document.getElementById('postfiles').onclick = function() {
                    set_upload_param(uploader, '', false);
                    return false;
                };
            },

            FilesAdded: function(up, files) {
                plupload.each(files, function(file) {
                    $("#ossfile").html('<div id="' + file.id + '">' + file.name + ' (' + plupload.formatSize(file.size) + ')<b></b>'
                        +'<div class="progress"><div class="progress-bar" style="width: 0%"></div></div>'
                        +'</div>');
                });
            },

            BeforeUpload: function(up, file) {
                set_upload_param(up, file.name, true);
            },

            UploadProgress: function(up, file) {
                var d=$("#"+file.id);
                d.children("b").html('<span>' + file.percent + "%</span>");
                d.children("div").children("div").css("width",file.percent + "%");
                d.children("div").children("div").css("background-color","green");
            },

            FileUploaded: function(up, file, info) {
                if (info.status == 200)
                {
                    $("#"+file.id).children("b").html('<span class="code">上传成功</span>');
                }
                else if (info.status == 203)
                {
                    document.getElementById(file.id).getElementsByTagName('b')[0].innerHTML = '上传到OSS成功，但是oss访问用户设置的上传回调服务器失败，失败原因是:' + info.response;
                }
                else
                {
                    document.getElementById(file.id).getElementsByTagName('b')[0].innerHTML = info.response;
                }
            },

            Error: function(up, err) {
                if (err.code == -600) {
                    document.getElementById('console').appendChild(document.createTextNode("\n选择的文件太大了,可以根据应用情况，在upload.js 设置一下上传的最大大小"));
                }
                else if (err.code == -601) {
                    document.getElementById('console').appendChild(document.createTextNode("\n选择的文件后缀不对,可以根据应用情况，在upload.js进行设置可允许的上传文件类型"));
                }
                else if (err.code == -602) {
                    document.getElementById('console').appendChild(document.createTextNode("\n这个文件已经上传过一遍了"));
                }
                else
                {
                    document.getElementById('console').appendChild(document.createTextNode("\nError xml:" + err.response));
                }
            }
        }
    });

    uploader.init();

    function set_upload_param(up, filename, ret)
    {
        $.ajax({
            url:"/admin/proxy_app/sign_url",
            type:"GET",
            success:function (res) {
                cache_path = res.data.dir+ rand_string +".ipa";
                console.log(cache_path);
                $("#c-path").val(cache_path);
                up.setOption({
                    'url': res.data.host,
                    'multipart_params': {
                        'key' : cache_path,
                        'policy': res.data.policy,
                        'OSSAccessKeyId': res.data.accessid,
                        'success_action_status' : '200', //让服务端返回200,不然，默认会返回204
                        // 'callback' : callbackbody,
                        'signature': res.data.signature,
                    }
                });
                up.start();
            }
        });
    }

    function random_string(len) {
        len = len || 32;
        var chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
        var maxPos = chars.length;
        var pwd = '';
        for (i = 0; i < len; i++) {
            pwd += chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd;
    }
</script>
